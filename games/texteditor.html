<!DOCTYPE html>
<html lang="en">

<head>
  <title>Text Editor</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="icon" href="../icon.png">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="texteditor/text-edit.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="texteditor/jscolor.js"></script>
  <script src="texteditor/FileSaver.js"></script>

</head>

<body>

<div class="container">
<div id="editor">
    <h1 id="title">Page Title</h1>
    <p id="body">Page content</p>
</div>
</div>





<div class = "container" id = "footer">

<div class = "row" id = "file-input"> 
<input type='file' name = 'file' class = 'inputfile' accept='text/plain' id='file' onchange='loadText(event)'>
</div>


<div class = "row" id = "appearance_pannel"> 
<p>
Background colour: <input class="jscolor" value="a5a5a5" id = 'backgroundColorPicker' onchange="updateBackground(this.jscolor)"> 
Text colour: <input class="jscolor" value="ffffff" id = 'textColorPicker' onchange="updateTextColor(this.jscolor)"> 
Header font size: <input type="text" id="header-size" > 
Body font size: <input type="text" id="body-size" >
</p>
</div>



<div class = "row"> 
<div class="btn-group" role="group">
  <button type="button" class="btn btn-secondary" id = "backgroundButton" onclick = "toggleAppearanceControl()" >Change appearance</button>
  <button type="button" class="btn btn-secondary" id = "saveButton" onclick = "download()">Save text</button>
  <button type="button" class="btn btn-secondary" id = "loadBurron"> <label for="file" >Load text</label></button>
</div>
</div>


</div>





<script type="text/javascript">

var title = document.getElementById('title');
var body = document.getElementById('body');
var filePannel = document.getElementById('file-input');
var appearancePannel = document.getElementById("appearance_pannel");
var backgroundButton = document.getElementById('backgroundButton');
var colorPicker = document.getElementById('colorPicker');

appearancePannel.style.display = 'none';

try {
  //chrome and safari
  title.contentEditable = 'plaintext-only';
  body.contentEditable = 'plaintext-only';
} 
catch (err) {
  //support for firefox and other browsers
  title.contentEditable = 'true';
  body.contentEditable = 'true';

  document.addEventListener("paste", function(e) {
      // cancel paste
      e.preventDefault();

      // get text representation of clipboard
      var text = e.clipboardData.getData("text/plain");

      // insert text manually
      document.execCommand("insertHTML", false, text);
    });  
}

getCookieSettings();

function toggleAppearanceControl() { 
  if (appearancePannel.style.display === 'none') {
      appearancePannel.style.display = 'block';
  } 
  else {
      appearancePannel.style.display = 'none';
  }
}

function updateBackground(jscolor) {
  document.body.style.backgroundColor = '#' + jscolor;
  setCookie('BackgroundColor', '#' + jscolor);
}

function updateTextColor(jscolor) {
  document.getElementById("editor").style.color = '#' + jscolor;
  setCookie('TextColor','#' + jscolor);
}

function setCookie(cname, cvalue) {
  document.cookie = cname + "=" + cvalue + ";";
  //;
}

function getCookie(cname) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') {
          c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
      }
  }
  return "";
}

function download() {
  var title_text = document.getElementById('title').innerText;
  var body_text = document.getElementById('body').innerText;
  var text = title_text + '\r\n\r\n' + body_text;
  var filename = "my_text";
  var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
  saveAs(blob, filename+".txt");
}

function loadText(event) {

  var input = event.target;
  var reader = new FileReader();

  reader.onload = function(){
    var text = reader.result;
    var pivot = text.indexOf("\r\n\r\n");
    var body = "Page content";
    var title = "Page Title";

    if (pivot > 800) {
      body = text;
    }

    else {
      if (pivot === -1) {
        pivot = text.indexOf("\n\n");
        if (pivot == -1) {
          body = text;
        }
        else {
          if (pivot > 800) {
              body = text;
          }
          else{
            title = text.substring(0,pivot);
            body = text.substring(pivot+2);
          }
        }
      }
      else {
        title = text.substring(0,pivot);
        body = text.substring(pivot+4);
      }
    }
    document.getElementById('title').innerText = title;
    document.getElementById('body').innerText = body;
  };

  reader.readAsText(input.files[0]);
};

function getCookieSettings() {
  var backgroundColor = getCookie('BackgroundColor');
  var textColor = getCookie('TextColor')

  if (!(backgroundColor === "")) {
    document.body.style.backgroundColor = backgroundColor;
    document.getElementById("backgroundColorPicker").value = backgroundColor.substring(1);
  }

  if (!(textColor === "")) {
    document.getElementById("editor").style.color = textColor;
    document.getElementById("textColorPicker").value = textColor.substring(1);
  }

  document.getElementById("title").style.fontSize = getCookie('TitleFontSize');
  document.getElementById("body").style.fontSize = getCookie('BodyFontSize');

  document.getElementById("header-size").value = getCookie('TitleFontSize');
  document.getElementById("body-size").value = getCookie('BodyFontSize');

  if (document.getElementById("header-size").value === "") {
    document.getElementById("header-size").value = "36px";
  }

  if (document.getElementById("body-size").value  === "") {
    document.getElementById("body-size").value = "14px";
  }
}

document.getElementById("header-size").addEventListener('keyup', function(e) {
  if (e.keyCode == 13) {
   var size = document.getElementById("header-size").value;
   document.getElementById("title").style.fontSize = size;
   setCookie('TitleFontSize', size );
  }
});

document.getElementById("body-size").addEventListener('keyup', function(e) {
  if (e.keyCode == 13) {
   var size = document.getElementById("body-size").value;
   document.getElementById("body").style.fontSize = size;
   setCookie('BodyFontSize', size );
  }
});


</script>





</body>
</html>
